name: Kiwi Browser CI/CD

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # 每周一 UTC 0 点自动触发

env:
  BUILD_DIR: out/Release
  APK_PREFIX: KiwiBrowser
  ANDROID_TARGETS: "arm64 x64"

jobs:
  build-pipeline:
    runs-on: ubuntu-22.04
    timeout-minutes: 400

steps:
      - name: Configure sparse checkout
        run: |
          git config --global core.sparseCheckout true
          git config --global core.sparseCheckoutCone false
          mkdir -p .git/info
          echo "/*" > .git/info/sparse-checkout
          echo "!third_party/*" >> .git/info/sparse-checkout
          echo "!tools/*" >> .git/info/sparse-checkout
          echo "!docs/*" >> .git/info/sparse-checkout

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: OutlinedArc217/kiwi-broken
          token: ${{ secrets.GH_TOKEN }}
          path: src
          fetch-depth: 1
          sparse-checkout: |
            /*
            !third_party/*
            !tools/*
            !docs/*

      # ============== 环境配置阶段 ==============
      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 python3-pip ninja-build \
            libncurses5 libglib2.0-0 libnss3 \
            openjdk-11-jdk-headless
          sudo update-java-alternatives --set java-1.11.0-openjdk-amd64

          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$GITHUB_WORKSPACE/depot_tools" >> $GITHUB_PATH

      # ============== 代码合并阶段 ==============
      - name: Merge Chromium updates
        working-directory: ./src
        run: |
          git config user.name "AutoMerger"
          git config user.email "automerger@kiwi"
          
          if ! git remote | grep -q chromium; then
            git remote add chromium https://chromium.googlesource.com/chromium/src
          fi

          git fetch chromium --tags --depth=1
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          
          git merge $LATEST_TAG -X ours --no-commit || true
          git commit -m "Merge Chromium $LATEST_TAG" || echo "No changes"

      # ============== 构建配置阶段 ==============
      strategy:
        matrix:
          arch: [arm64, x64]
        fail-fast: false

      - name: Configure build for ${{ matrix.arch }}
        working-directory: ./src
        run: |
          mkdir -p out/${{ matrix.arch }}
          cat << EOF > out/${{ matrix.arch }}/args.gn
          target_os = "android"
          target_cpu = "${{ matrix.arch }}"
          is_debug = false
          is_official_build = true
          symbol_level = 1
          android_default_version_code = "$(date +%Y%m%d)"
          android_keystore_name = "release"
          android_keystore_password = "${{ secrets.KEY_STORE_PASSWORD }}"
          android_keystore_path = "../../../keystore.jks"
          EOF

      # ============== 编译阶段 ==============
      - name: Build APK (${{ matrix.arch }})
        working-directory: ./src
        run: |
          gn gen out/${{ matrix.arch }} --args="$(cat out/${{ matrix.arch }}/args.gn)"
          autoninja -C out/${{ matrix.arch }} chrome_public_apk -j $(nproc)

      # ============== 产物处理阶段 ==============
      - name: Sign APKs
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: src/out
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
          apkSigningScheme: v2
          apkPaths: |
            **/ChromePublic.apk

      - name: Rename artifacts
        run: |
          find src/out -name "ChromePublic.apk" -exec sh -c '
            dir=$(dirname {})
            arch=$(basename $dir)
            mv {} src/out/${{ env.APK_PREFIX }}_${arch}_$(date +%Y%m%d).apk
          ' \;

      # ============== 发布阶段 ==============
      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src/out/*.apk
          tag_name: kiwi-${{ github.run_id }}
          name: "Kiwi Build $(date +%F)"
          body: |
            **构建信息**
            - Chromium 版本: $(grep '^LASTCHANGE=' src/build/util/LASTCHANGE | cut -d'=' -f2)
            - 构建时间: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
            - 目标架构: ${{ env.ANDROID_TARGETS }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
